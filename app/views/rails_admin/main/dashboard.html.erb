<div class="alert alert-info">
  <%= link_to "Manage Kiosks", rails_admin.index_path('Kiosk'), class: 'btn btn-primary' %>
  <%= link_to "Manage Slides", rails_admin.index_path('slide'), class: "btn btn-primary mr-2" %>
  <%= link_to "Add New Slide", rails_admin.new_path('slide'),   class: "btn btn-success" %>
</div>

<% if Slide.fallbacks.none? %>
  <div class="alert alert-warning" style="margin-bottom:1em;">
    <strong>No fallback slides defined.</strong><br/>
    When a kiosk has no active slides, it will go blank.
    Please mark one or more slides as a fallback under
    <a href="<%= rails_admin.index_path('Slide') %>">Admin → Slides</a>.
  </div>
<% end %>

<%# --- Date Range and Preset Buttons --- %>
<%
  today        = Date.current
  last_30_days = (today - 29.days)..today
  curr_month   = today.beginning_of_month..today
  prev_month   = (today - 1.month).beginning_of_month..(today - 1.month).end_of_month
  curr_year    = today.beginning_of_year..today
  prev_year    = (today.last_year.beginning_of_year)..(today.last_year.end_of_year)

  start_date   = params[:start].present? ? Date.parse(params[:start]) : last_30_days.begin
  end_date     = params[:end].present?   ? Date.parse(params[:end])   : last_30_days.end

  sessions = KioskSession.includes(kiosk: :kiosk_group).where(started_at: start_date.beginning_of_day..end_date.end_of_day)

  # Which kiosk groups does this user have access to?
  accessible_groups = current_user.admin? ? KioskGroup.all : current_user.kiosk_groups

  # Only include groups that had sessions in the selected range
  group_ids_with_sessions = sessions.map { |s| s.kiosk&.kiosk_group_id }.compact.uniq
  available_groups = accessible_groups.where(id: group_ids_with_sessions)

  # The special dropdown options
  all_key = current_user.admin? ? "all_kiosks" : "all_my_kiosks"
  all_label = current_user.admin? ? "All Kiosks" : "All My Kiosks"

  # Build dropdown choices
  group_choices = available_groups.map { |g| [g.name, g.id] }.sort_by(&:first)
  dropdown_options = [[all_label, all_key]] + group_choices

  # Which group is currently selected?
  selected_group = params[:kiosk_group].presence || all_key

  # Which sessions to show?
  sessions_to_show =
    if selected_group == "all_kiosks" && current_user.admin?
      sessions
    elsif selected_group == "all_my_kiosks"
      sessions.select { |s| s.kiosk && current_user.kiosk_groups.include?(s.kiosk.kiosk_group) }
    else
      group = available_groups.find { |g| g.id.to_s == selected_group }
      group ? sessions.select { |s| s.kiosk&.kiosk_group_id == group.id } : []
    end

  # If nothing is selected, default to the group with the most sessions
  if selected_group.blank? || !dropdown_options.any? { |(_, val)| val == selected_group }
    counts = available_groups.each_with_object(Hash.new(0)) do |g, h|
      h[g.id] = sessions.count { |s| s.kiosk&.kiosk_group_id == g.id }
    end
    most_sessions = counts.max_by { |_k, v| v }
    selected_group = most_sessions ? most_sessions[0].to_s : all_key
    # now recalc sessions_to_show
    if selected_group == "all_kiosks" && current_user.admin?
      sessions_to_show = sessions
    elsif selected_group == "all_my_kiosks"
      sessions_to_show = sessions.select { |s| s.kiosk && current_user.kiosk_groups.include?(s.kiosk.kiosk_group) }
    else
      group = available_groups.find { |g| g.id.to_s == selected_group }
      sessions_to_show = group ? sessions.select { |s| s.kiosk&.kiosk_group_id == group.id } : []
    end
  end

  # Group the sessions for display: kiosk → host
  grouped = sessions_to_show.group_by { |s| s.kiosk&.name || s.kiosk_code }
    .transform_values { |kiosk_sessions| kiosk_sessions.group_by(&:host) }
%>

<div class="card mt-4">
  <div class="card-header">
    <h5 class="mb-0">Kiosk Usage (<%= start_date.strftime("%Y-%m-%d") %> to <%= end_date.strftime("%Y-%m-%d") %>)</h5>
  </div>
  <div class="card-body">
    <%= form_with url: rails_admin.dashboard_path, method: :get, local: true, class: "form-inline mb-2" do %>
      <label class="mr-2 font-weight-bold">Start:</label>
      <%= date_field_tag :start, start_date, class: "form-control mr-2" %>
      <label class="mr-2 font-weight-bold">End:</label>
      <%= date_field_tag :end, end_date, class: "form-control mr-2" %>

      <label class="mr-2 font-weight-bold">Kiosk Group:</label>
      <%= select_tag :kiosk_group, options_for_select(dropdown_options, selected_group), class: "form-control mr-2", onchange: "this.form.submit();" %>

      <%= submit_tag "Apply", class: "btn btn-primary mr-2" %>

      <%= link_to "Last 30 Days", rails_admin.dashboard_path(start: last_30_days.begin, end: last_30_days.end), class: "btn btn-outline-secondary btn-sm mr-1" %>
      <%= link_to "Current Month", rails_admin.dashboard_path(start: curr_month.begin, end: curr_month.end), class: "btn btn-outline-secondary btn-sm mr-1" %>
      <%= link_to "Previous Month", rails_admin.dashboard_path(start: prev_month.begin, end: prev_month.end), class: "btn btn-outline-secondary btn-sm mr-1" %>
      <%= link_to "Current Year", rails_admin.dashboard_path(start: curr_year.begin, end: curr_year.end), class: "btn btn-outline-secondary btn-sm mr-1" %>
      <%= link_to "Previous Year", rails_admin.dashboard_path(start: prev_year.begin, end: prev_year.end), class: "btn btn-outline-secondary btn-sm" %>
    <% end %>

    <% if grouped.any? %>
      <% grouped.each do |kiosk_name, hosts| %>
        <div class="mt-4">
          <h6 class="border-bottom pb-1"><%= kiosk_name %></h6>
          <table class="table table-sm mb-4">
            <thead>
              <tr>
                <th>Host</th>
                <th>Sessions</th>
                <th>First Session</th>
                <th>Last Session</th>
                <th>Avg Duration</th>
              </tr>
            </thead>
            <tbody>
              <% hosts.each do |host, host_sessions| %>
                <tr>
                  <td><%= host %></td>
                  <td><%= host_sessions.count %></td>
                  <td><%= host_sessions.map(&:started_at).min&.strftime("%Y-%m-%d %H:%M") %></td>
                  <td><%= host_sessions.map(&:ended_at).compact.max&.strftime("%Y-%m-%d %H:%M") %></td>
                  <td>
                    <% durations = host_sessions.map(&:session_duration).compact %>
                    <%= durations.any? ? "#{(durations.sum / durations.size / 60).round(1)} min" : "-" %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    <% else %>
      <div class="mt-3">
        <em>No data for selected range and group.</em>
      </div>
    <% end %>
  </div>
</div>
