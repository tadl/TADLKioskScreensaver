<%# app/views/rails_admin/_kiosk_status_grid.html.erb %>
<%# Live Kiosk Status grid + clickable host rows -> modal w/ heartbeat + logs %>

<% if defined?(KioskStatus) %>
  <% user = current_user %>

  <% kiosk_scope =
       if user&.admin?
         Kiosk.all
       else
         Kiosk.where(kiosk_group_id: user&.kiosk_group_ids.to_a)
       end %>

  <% statuses = KioskStatus
      .includes(kiosk: :kiosk_group)
      .where(kiosk_id: kiosk_scope.select(:id))
      .order('kiosk_groups.name NULLS LAST, kiosks.name ASC, host ASC') %>

  <% grouped = statuses.group_by(&:kiosk) %>

  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Live Kiosk Status</h5>
    </div>

    <div class="card-body">
      <% if grouped.blank? %>
        <em>No kiosk status recorded yet. Entries will appear as kiosks enter the screensaver and exit to the OPAC.</em>
      <% else %>
        <div class="row">
          <% grouped
             .sort_by { |kiosk, _| [kiosk.kiosk_group&.name.to_s, kiosk.name.to_s] }
             .each do |kiosk, rows| %>

            <div class="col-md-4 col-lg-3 mb-3">
              <div class="border rounded p-3 h-100">
                <div class="mb-2">
                  <strong><%= kiosk.name %></strong>
                </div>

                <% rows.each do |s| %>
                  <% seconds = (Time.zone.now - s.state_changed_at).to_i
                     hours   = seconds / 3600
                     minutes = (seconds % 3600) / 60
                     label   = hours.positive? ? "#{hours}h#{format('%02d', minutes)}m" : "#{minutes}m"

                     active  = (s.state == 'opac')
                     row_class =
                       if active
                         'bg-success text-white'
                       else
                         'bg-warning text-dark'
                       end
                  %>

                  <div
                    class="d-flex align-items-center justify-content-between rounded-3 px-2 py-1 mb-1 <%= row_class %> kiosk-host-row"
                    data-kiosk-host="<%= s.host %>"
                    style="cursor: pointer;"
                    title="<%= "#{s.host} #{s.state} since #{l(s.state_changed_at, format: :short)} — click for details" %>">
                    <span class="fw-semibold"><%= s.host %></span>
                    <span class="text-monospace small"><%= label %></span>
                  </div>
                <% end %>

              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <div class="modal fade" id="kioskHostModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="kioskHostModalTitle">Kiosk</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="kioskHostModalBody">
          <div class="text-muted">Loading…</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      function esc(s) {
        return String(s ?? "").replace(/[&<>"']/g, function (c) {
          return ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" })[c];
        });
      }

      function fmtTime(t) {
        if (!t) return "";
        try { return new Date(t).toLocaleString(); } catch (e) { return String(t); }
      }

      function isUrl(s) {
        return typeof s === "string" && /^https?:\/\//i.test(s);
      }

      function linkify(url, label) {
        if (!isUrl(url)) return "";
        var text = label || url;
        return '<a href="' + esc(url) + '" target="_blank" rel="noopener">' + esc(text) + '</a>';
      }

      async function fetchHost(host) {
        var url = "/admin/kiosk_hosts/" + encodeURIComponent(host) + ".json";
        var resp = await fetch(url, { headers: { "Accept": "application/json" }, cache: "no-store" });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        return await resp.json();
      }

      function humanDuration(seconds) {
        seconds = Number(seconds);
        if (!Number.isFinite(seconds) || seconds <= 0) return "0s";

        const units = [
          ["d",  24 * 60 * 60],
          ["h",  60 * 60],
          ["m",  60],
          ["s",  1],
        ];

        const parts = [];
        for (const [label, size] of units) {
          if (seconds >= size) {
            const q = Math.floor(seconds / size);
            seconds = seconds % size;
            parts.push(`${q}${label}`);
          }
        }
        return parts.join(" ");
      }

      function renderHeartbeat(hb) {
        if (!hb || !hb.kiosk_id) {
          return '<div class="text-muted mb-3">No heartbeat recorded for this host yet.</div>';
        }

        var lines = [];
        lines.push('<div><strong>Last seen:</strong> ' + esc(fmtTime(hb.last_seen_at)) + '</div>');
        lines.push('<div><strong>Uptime:</strong> ' + esc(humanDuration(hb.uptime_seconds)) + '</div>');
        lines.push('<div><strong>Kiosk service:</strong> ' + esc(hb.kiosk_service ?? "") + '</div>');
        lines.push('<div><strong>Chromium pids:</strong> ' + esc(hb.chromium_pids ?? "") + '</div>');

        if (hb.chromium_devtools_ok !== undefined && hb.chromium_devtools_ok !== null) {
          lines.push('<div><strong>DevTools OK:</strong> ' + esc(hb.chromium_devtools_ok) + '</div>');
        }
        if (hb.chromium_devtools_http) {
          lines.push('<div><strong>DevTools HTTP:</strong> ' + esc(hb.chromium_devtools_http) + '</div>');
        }
        if (hb.chromium_devtools_ms !== undefined && hb.chromium_devtools_ms !== null) {
          lines.push('<div><strong>DevTools ms:</strong> ' + esc(hb.chromium_devtools_ms) + '</div>');
        }

        return (
          '<div class="mb-3">' +
            '<h6 class="mb-2">Heartbeat</h6>' +
            '<div class="small">' + lines.join("") + '</div>' +
          '</div>'
        );
      }

      function renderLogItem(l) {
        var level = (l.level || "").toString();
        var occurred = fmtTime(l.occurred_at);

        // Badge-ish, but readable
        var levelClass = "bg-secondary";
        if (level === "error") levelClass = "bg-danger";
        else if (level === "warn" || level === "warning") levelClass = "bg-warning text-dark";
        else if (level === "info") levelClass = "bg-info text-dark";

        var kind = l.kind ? ('<span class="ms-2 text-muted">(' + esc(l.kind) + ')</span>') : "";
        var where = "";
        if (l.source || l.lineno || l.colno) {
          var parts = [];
          if (l.source) parts.push(esc(l.source));
          if (l.lineno) parts.push("line " + esc(l.lineno));
          if (l.colno) parts.push("col " + esc(l.colno));
          where = '<div class="text-muted small mt-1">' + parts.join(" · ") + "</div>";
        }

        var links = [];
        if (l.tab_url) links.push("Tab: " + linkify(l.tab_url, "open"));
        if (l.href)    links.push("Href: " + linkify(l.href, "open"));
        var linksHtml = links.length ? '<div class="small mt-1">' + links.join(" &nbsp; ") + "</div>" : "";

        var stackHtml = "";
        if (l.stack) {
          stackHtml =
            '<details class="mt-2">' +
              '<summary class="small">Stack trace</summary>' +
              '<pre class="mt-2 p-2 bg-light border rounded small" style="white-space:pre-wrap; max-height:300px; overflow:auto;">' +
                esc(l.stack) +
              '</pre>' +
            '</details>';
        }

        return (
          '<div class="list-group-item">' +
            '<div class="d-flex justify-content-between align-items-start">' +
              '<div class="me-3">' +
                '<span class="badge ' + levelClass + '">' + esc(level || "log") + "</span>" +
                kind +
              "</div>" +
              '<div class="text-muted small text-nowrap">' + esc(occurred) + "</div>" +
            "</div>" +
            '<div class="mt-2">' + esc(l.message ?? "") + "</div>" +
            where +
            linksHtml +
            stackHtml +
          "</div>"
        );
      }

      function renderLogs(logs) {
        if (!Array.isArray(logs) || logs.length === 0) {
          return '<div class="text-muted">No logs recorded for this host yet.</div>';
        }

        return (
          '<div>' +
            '<h6 class="mb-2">Recent logs</h6>' +
            '<div class="list-group">' +
              logs.map(renderLogItem).join("") +
            "</div>" +
          "</div>"
        );
      }

      function renderBody(data) {
        var hb = data.heartbeat || null;
        var logs = Array.isArray(data.logs) ? data.logs : [];
        return renderHeartbeat(hb) + renderLogs(logs);
      }

      function showModal(title, bodyHtml) {
        var titleEl = document.getElementById("kioskHostModalTitle");
        var bodyEl  = document.getElementById("kioskHostModalBody");
        var modalEl = document.getElementById("kioskHostModal");
        if (!titleEl || !bodyEl || !modalEl) return;

        titleEl.textContent = title;
        bodyEl.innerHTML = bodyHtml;

        if (window.bootstrap && window.bootstrap.Modal) {
          window.bootstrap.Modal.getOrCreateInstance(modalEl).show();
          return;
        }
        if (window.jQuery && window.jQuery.fn && window.jQuery.fn.modal) {
          window.jQuery(modalEl).modal("show");
          return;
        }

        modalEl.classList.add("show");
        modalEl.style.display = "block";
      }

      document.addEventListener("click", async function (e) {
        var row = e.target.closest && e.target.closest(".kiosk-host-row[data-kiosk-host]");
        if (!row) return;

        var host = row.getAttribute("data-kiosk-host");
        if (!host) return;

        showModal(host, '<div class="text-muted">Loading…</div>');

        try {
          var data = await fetchHost(host);
          if (!data || data.ok !== true) throw new Error((data && data.error) || "not ok");
          showModal(host, renderBody(data));
        } catch (err) {
          showModal(host, '<div class="text-danger">Failed to load host details: ' + esc(err && err.message ? err.message : err) + '</div>');
        }
      });
    })();
  </script>
<% end %>
