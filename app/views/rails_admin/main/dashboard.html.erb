<div class="alert alert-info">
  <%= link_to "Manage Kiosks", rails_admin.index_path('Kiosk'), class: 'btn btn-primary' %>
  <%= link_to "Manage Slides", rails_admin.index_path('slide'), class: "btn btn-primary mr-2" %>
  <%= link_to "Add New Slide", rails_admin.new_path('slide'),   class: "btn btn-success" %>
</div>

<% if Slide.fallbacks.none? %>
  <div class="alert alert-warning" style="margin-bottom:1em;">
    <strong>No fallback slides defined.</strong><br/>
    When a kiosk has no active slides, it will go blank.
    Please mark one or more slides as a fallback under
    <a href="<%= rails_admin.index_path('Slide') %>">Admin â†’ Slides</a>.
  </div>
<% end %>

<%# --- Date Range and Preset Buttons --- %>
<%
  today        = Date.current
  last_30_days = (today - 29.days)..today
  curr_month   = today.beginning_of_month..today
  prev_month   = (today - 1.month).beginning_of_month..(today - 1.month).end_of_month
  curr_year    = today.beginning_of_year..today
  prev_year    = (today.last_year.beginning_of_year)..(today.last_year.end_of_year)

  start_date   = params[:start].present? ? Date.parse(params[:start]) : last_30_days.begin
  end_date     = params[:end].present?   ? Date.parse(params[:end])   : last_30_days.end

  sessions = KioskSession
    .where(started_at: start_date.beginning_of_day..end_date.end_of_day)

  grouped = sessions.group_by { |s| s.kiosk&.kiosk_group&.name || "No Group" }
    .transform_values { |sessions_in_group|
      sessions_in_group.group_by { |s| s.kiosk&.name || s.kiosk_code }
        .transform_values { |sessions_in_kiosk|
          sessions_in_kiosk.group_by(&:host)
        }
    }
%>

<div class="card mt-4">
  <div class="card-header">
    <h5 class="mb-0">Kiosk Usage (<%= start_date.strftime("%Y-%m-%d") %> to <%= end_date.strftime("%Y-%m-%d") %>)</h5>
  </div>
  <div class="card-body">
    <%= form_with url: rails_admin.dashboard_path, method: :get, local: true, class: "form-inline mb-2" do %>
      <label class="mr-2 font-weight-bold">Start:</label>
      <%= date_field_tag :start, start_date, class: "form-control mr-2" %>
      <label class="mr-2 font-weight-bold">End:</label>
      <%= date_field_tag :end, end_date, class: "form-control mr-2" %>
      <%= submit_tag "Apply", class: "btn btn-primary mr-2" %>

      <%= link_to "Last 30 Days", rails_admin.dashboard_path(start: last_30_days.begin, end: last_30_days.end), class: "btn btn-outline-secondary btn-sm mr-1" %>
      <%= link_to "Current Month", rails_admin.dashboard_path(start: curr_month.begin, end: curr_month.end), class: "btn btn-outline-secondary btn-sm mr-1" %>
      <%= link_to "Previous Month", rails_admin.dashboard_path(start: prev_month.begin, end: prev_month.end), class: "btn btn-outline-secondary btn-sm mr-1" %>
      <%= link_to "Current Year", rails_admin.dashboard_path(start: curr_year.begin, end: curr_year.end), class: "btn btn-outline-secondary btn-sm mr-1" %>
      <%= link_to "Previous Year", rails_admin.dashboard_path(start: prev_year.begin, end: prev_year.end), class: "btn btn-outline-secondary btn-sm" %>
    <% end %>

    <% if grouped.any? %>
      <% grouped.each do |group_name, kiosks| %>
        <div class="mt-4">
          <h5 class="border-bottom pb-1"><%= group_name %></h5>
          <% kiosks.each do |kiosk_name, hosts| %>
            <h6 class="mt-3"><%= kiosk_name %></h6>
            <table class="table table-sm mb-4">
              <thead>
                <tr>
                  <th>Host</th>
                  <th>Sessions</th>
                  <th>First Session</th>
                  <th>Last Session</th>
                  <th>Avg Duration</th>
                </tr>
              </thead>
              <tbody>
                <% hosts.each do |host, host_sessions| %>
                  <tr>
                    <td><%= host %></td>
                    <td><%= host_sessions.count %></td>
                    <td><%= host_sessions.map(&:started_at).min&.strftime("%Y-%m-%d %H:%M") %></td>
                    <td><%= host_sessions.map(&:ended_at).compact.max&.strftime("%Y-%m-%d %H:%M") %></td>
                    <td>
                      <% durations = host_sessions.map(&:session_duration).compact %>
                      <%= durations.any? ? "#{(durations.sum / durations.size / 60).round(1)} min" : "-" %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          <% end %>
        </div>
      <% end %>
    <% else %>
      <div class="mt-3">
        <em>No data for selected range.</em>
      </div>
    <% end %>
  </div>
</div>
